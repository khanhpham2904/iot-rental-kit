import React, { useState, useEffect } from 'react';
import { BrowserRouter as Router, Routes, Route, Link, useNavigate } from 'react-router-dom';
import AdminPortal from './AdminPortal';
import LeaderPortal from './LeaderPortal';
import AcademicAffairsPortal from './AcademicAffairsPortal';
import RentalRequestPage from './RentalRequestPage';
import AdminRentalApprovalPage from './AdminRentalApprovalPage';
import AdminRefundApprovalPage from './AdminRefundApprovalPage';
import { motion, AnimatePresence } from 'framer-motion';
import {
  Layout,
  Menu,
  Card,
  Table,
  Button,
  Input,
  Select,
  Modal,
  Form,
  message,
  Tag,
  Row,
  Col,
  Statistic,
  Typography,
  Space,
  Tooltip,
  Avatar,
  Badge,
  Divider,
  List,
  Timeline,
  Progress,
  Switch,
  DatePicker,
  Upload,
  Drawer,
  Tabs,
  Alert,
  Descriptions,
  Steps,
  Result,
  Empty,
  Skeleton,
  Spin,
  notification
} from 'antd';
import {
  DashboardOutlined,
  SettingOutlined,
  UserOutlined,
  TeamOutlined,
  ToolOutlined,
  ShoppingOutlined,
  FileTextOutlined,
  LogoutOutlined,
  PlusOutlined,
  EditOutlined,
  DeleteOutlined,
  EyeOutlined,
  CheckCircleOutlined,
  CloseCircleOutlined,
  ClockCircleOutlined,
  ExclamationCircleOutlined,
  ReloadOutlined,
  DownloadOutlined,
  UploadOutlined,
  SearchOutlined,
  FilterOutlined,
  BarChartOutlined,
  PieChartOutlined,
  LineChartOutlined,
  BellOutlined,
  MailOutlined,
  CalendarOutlined,
  EnvironmentOutlined,
  DollarOutlined,
  TrophyOutlined,
  SafetyCertificateOutlined,
  BugOutlined,
  BuildOutlined,
  CarOutlined,
  HomeOutlined,
  BookOutlined,
  ExperimentOutlined,
  RobotOutlined,
  WifiOutlined,
  ThunderboltOutlined,
  BulbOutlined,
  HeartOutlined,
  StarOutlined,
  LikeOutlined,
  DislikeOutlined,
  QuestionCircleOutlined,
  InfoCircleOutlined,
  WarningOutlined,
  CheckOutlined,
  StopOutlined,
  PlayCircleOutlined,
  PauseCircleOutlined,
  StepForwardOutlined,
  StepBackwardOutlined,
  FastForwardOutlined,
  FastBackwardOutlined,
  ShuffleOutlined,
  RetweetOutlined,
  SwapOutlined,
  SwapLeftOutlined,
  SwapRightOutlined,
  MenuFoldOutlined,
  MenuUnfoldOutlined,
  LoadingOutlined
} from '@ant-design/icons';
import AppBar from '@mui/material/AppBar';
import Toolbar from '@mui/material/Toolbar';
import Button from '@mui/material/Button';
import Typography from '@mui/material/Typography';
import Box from '@mui/material/Box';
import Card from '@mui/material/Card';
import CardContent from '@mui/material/CardContent';
import TextField from '@mui/material/TextField';
import Alert from '@mui/material/Alert';
import Select from '@mui/material/Select';
import MenuItem from '@mui/material/MenuItem';
import InputLabel from '@mui/material/InputLabel';
import FormControl from '@mui/material/FormControl';
import Stack from '@mui/material/Stack';
import Dialog from '@mui/material/Dialog';
import DialogTitle from '@mui/material/DialogTitle';
import DialogContent from '@mui/material/DialogContent';
import DialogActions from '@mui/material/DialogActions';
import Table from '@mui/material/Table';
import TableBody from '@mui/material/TableBody';
import TableCell from '@mui/material/TableCell';
import TableContainer from '@mui/material/TableContainer';
import TableHead from '@mui/material/TableHead';
import TableRow from '@mui/material/TableRow';
import Paper from '@mui/material/Paper';
import Chip from '@mui/material/Chip';
import Grid from '@mui/material/Grid';
import Drawer from '@mui/material/Drawer';
import List from '@mui/material/List';
import ListItem from '@mui/material/ListItem';
import ListItemButton from '@mui/material/ListItemButton';
import ListItemIcon from '@mui/material/ListItemIcon';
import ListItemText from '@mui/material/ListItemText';
import DashboardIcon from '@mui/icons-material/Dashboard';
import InventoryIcon from '@mui/icons-material/Inventory';
import MonetizationOnIcon from '@mui/icons-material/MonetizationOn';
import ReplayIcon from '@mui/icons-material/Replay';
import GroupIcon from '@mui/icons-material/Group';
import PeopleIcon from '@mui/icons-material/People';
import * as XLSX from 'xlsx';
import { mockLogin, mockGroups, mockKits, mockWallet, mockNotifications, mockReport, mockAssignments, mockUsers } from './mocks';
import { 
  kitAPI, 
  groupAPI, 
  walletAPI, 
  rentalAPI, 
  refundAPI, 
  studentAPI 
} from './api';

function Home({ onLogin, user }) {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [error, setError] = useState('');
  const navigate = useNavigate();
  const roleOptions = mockUsers.map(u => ({ value: u.role, label: u.name, email: u.email, password: u.password }));

  const handleLoginAs = async (userObj) => {
    setEmail(userObj.email);
    setPassword(userObj.password);
    setError('');
    try {
      const user = await mockLogin(userObj.email, userObj.password);
      onLogin(user);
      if (user.role === 'lecturer') {
        navigate('/lecturer');
      } else if (user.role === 'member') {
        navigate('/');
      } else if (user.role === 'admin') {
        navigate('/');
      } else if (user.role === 'academic') {
        navigate('/');
      } else {
        navigate('/');
      }
    } catch (err) {
      setError(err.message || 'Login failed');
    }
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    setError('');
    try {
      const user = await mockLogin(email, password);
      onLogin(user);
      if (user.role === 'lecturer') {
        navigate('/lecturer');
      } else if (user.role === 'member') {
        navigate('/');
      } else if (user.role === 'admin') {
        navigate('/');
      } else if (user.role === 'academic') {
        navigate('/');
      } else {
        navigate('/');
      }
    } catch (err) {
      setError(err.message || 'Login failed');
    }
  };

  if (user) {
    return (
      <Card sx={{ maxWidth: 400, mx: 'auto', mt: 4, borderRadius: 4, boxShadow: 6 }}>
        <CardContent>
          <Typography variant="h5" gutterBottom fontWeight={700}>Welcome, {user.email}</Typography>
          <Typography variant="body1">Role: {user.role}</Typography>
        </CardContent>
      </Card>
    );
  }

  return (
    <Box sx={{ minHeight: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center', background: 'linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%)' }}>
      <Card sx={{ p: 4, borderRadius: 4, boxShadow: 8, minWidth: 340, maxWidth: 500, width: '100%' }}>
        <Box sx={{ display: 'flex', flexDirection: 'column', alignItems: 'center', mb: 2 }}>
          <img src={require('./logo.svg').default} alt="Logo" style={{ width: 64, marginBottom: 12 }} />
          <Typography variant="h4" fontWeight={700} gutterBottom>Login</Typography>
        </Box>
        {/* Table for all roles */}
        <TableContainer component={Paper} sx={{ mb: 3 }}>
          <Table size="small">
            <TableHead>
              <TableRow>
                <TableCell>Name</TableCell>
                <TableCell>Role</TableCell>
                <TableCell>Email</TableCell>
                <TableCell align="center">Action</TableCell>
              </TableRow>
            </TableHead>
            <TableBody>
              {mockUsers.map((u) => (
                <TableRow key={u.email}>
                  <TableCell>{u.name}</TableCell>
                  <TableCell>{u.role}</TableCell>
                  <TableCell>{u.email}</TableCell>
                  <TableCell align="center">
                    <Button size="small" variant="contained" color="primary" onClick={() => handleLoginAs(u)}>
                      Login as
                    </Button>
                  </TableCell>
                </TableRow>
              ))}
            </TableBody>
          </Table>
        </TableContainer>
        {error && <Alert severity="error" sx={{ mb: 2 }}>{error}</Alert>}
      </Card>
    </Box>
  );
}

// LeaderPortal is now imported from separate file
    setMessage('');
    try {
      // Simulate deposit
      setWallet(prev => ({
        ...prev,
        balance: prev.balance + 100000,
        transactions: [...prev.transactions, {
          type: 'Deposit',
          amount: 100000,
          date: new Date().toISOString().split('T')[0]
        }]
      }));
      setMessage('Deposit successful!');
    } catch (error) {
      setMessage(error.message || 'Deposit failed');
    }
  };

  const handleChooseKit = async (kitName) => {
    // Find the selected kit
    const selectedKit = kits.find(k => k.name === kitName);
    if (!selectedKit) {
      setMessage('Kit not found');
      return;
    }
    
    // Navigate to rental request page
    navigate('/rental-request', { 
      state: { 
        kit: selectedKit, 
        user: user 
      } 
    });
  };

  const handleRefundRequest = () => {
    setRefundDialog(true);
  };

  const handleRefundSubmit = async () => {
    if (!refundReason.trim() || !refundDate) {
      setMessage('Please fill in all fields');
      return;
    }

    try {
      // Simulate refund request submission
      setMessage('Refund request submitted successfully!');
      setRefundDialog(false);
      setRefundReason('');
      setRefundDate('');
    } catch (error) {
      setMessage(error.message || 'Failed to submit refund request');
    }
  };



  const renderKitRental = () => (
    <Box>
      <Typography variant="h5" gutterBottom>Kit Rental</Typography>
      
      {/* Group Information Card */}
      {loading ? (
        <Typography>Loading group info...</Typography>
      ) : group ? (
        <Card sx={{ mb: 3, bgcolor: 'primary.light', color: 'white' }}>
          <CardContent>
            <Typography variant="h6" gutterBottom>Group Information</Typography>
            <Grid container spacing={2}>
              <Grid item xs={12} md={6}>
                <Typography variant="body1">
                  <strong>Group Name:</strong> {group.name}
                </Typography>
                <Typography variant="body1">
                  <strong>Total Members:</strong> {group.members.length + 1} (including you)
                </Typography>
              </Grid>
              <Grid item xs={12} md={6}>
                <Typography variant="body1">
                  <strong>Members:</strong> {group.members.join(', ')}
                </Typography>
                {group.lecturer && (
                  <Typography variant="body1">
                    <strong>Lecturer:</strong> {group.lecturer}
                  </Typography>
                )}
              </Grid>
            </Grid>
          </CardContent>
        </Card>
      ) : (
        <Alert severity="warning" sx={{ mb: 3 }}>
          <Typography variant="body1">No group found for this leader.</Typography>
        </Alert>
      )}
      
      <Typography variant="h6" sx={{ mt: 2 }}>Available Kits</Typography>
      {kitsLoading ? (
        <Typography>Loading kits...</Typography>
      ) : kits.length > 0 ? (
        <TableContainer component={Paper}>
          <Table>
            <TableHead>
              <TableRow>
                <TableCell>Name</TableCell>
                <TableCell>Category</TableCell>
                <TableCell>Quantity</TableCell>
                <TableCell>Price</TableCell>
                <TableCell>Status</TableCell>
                <TableCell>Actions</TableCell>
              </TableRow>
            </TableHead>
            <TableBody>
              {kits.map((k, i) => (
                <TableRow key={i}>
                  <TableCell>
                    <Button
                      variant="text"
                      size="small"
                      onClick={() => {
                        setSelectedKit(k);
                        setKitDetailDialog(true);
                      }}
                    >
                      {k.name}
                    </Button>
                  </TableCell>
                  <TableCell>
                    <Chip 
                      label={k.category || 'N/A'} 
                      color={k.category === 'Advanced' ? 'warning' : k.category === 'Professional' ? 'error' : 'default'} 
                      size="small" 
                    />
                  </TableCell>
                  <TableCell>{k.quantity}</TableCell>
                  <TableCell>{k.price ? k.price.toLocaleString() + ' VND' : 'N/A'}</TableCell>
                  <TableCell>
                    <Chip 
                      label={k.status} 
                      color={k.status === 'AVAILABLE' ? 'success' : k.status === 'IN-USE' ? 'warning' : 'error'} 
                      size="small" 
                    />
                  </TableCell>
                  <TableCell>
                    <Button
                      variant="contained"
                      size="small"
                      disabled={k.quantity === 0 || k.status !== 'AVAILABLE'}
                      onClick={() => handleChooseKit(k.name)}
                    >
                      Rent Kit
                    </Button>
                  </TableCell>
                </TableRow>
              ))}
            </TableBody>
          </Table>
        </TableContainer>
      ) : (
        <Typography>No kits available.</Typography>
      )}
    </Box>
  );

  const renderWallet = () => (
    <Box>
      <Typography variant="h5" gutterBottom>Wallet Management</Typography>
      <Card sx={{ mb: 3 }}>
        <CardContent>
          <Typography variant="h4" color="primary" gutterBottom>
            Balance: {wallet.balance.toLocaleString()} VND
          </Typography>
          <Button 
            variant="contained" 
            color="primary" 
            onClick={handleDeposit}
            sx={{ mb: 2 }}
          >
            Deposit 100,000 VND
          </Button>
        </CardContent>
      </Card>

      <Typography variant="h6" gutterBottom>Transaction History</Typography>
      <TableContainer component={Paper}>
        <Table>
          <TableHead>
            <TableRow>
              <TableCell>Type</TableCell>
              <TableCell>Amount</TableCell>
              <TableCell>Date</TableCell>
            </TableRow>
          </TableHead>
          <TableBody>
            {wallet.transactions.map((tx, idx) => (
              <TableRow key={idx}>
                <TableCell>{tx.type}</TableCell>
                <TableCell>{tx.amount.toLocaleString()} VND</TableCell>
                <TableCell>{tx.date}</TableCell>
              </TableRow>
            ))}
          </TableBody>
        </Table>
      </TableContainer>
    </Box>
  );

  const renderRefundRequests = () => (
    <Box>
      <Typography variant="h5" gutterBottom>Refund Requests</Typography>
      <Button 
        variant="contained" 
        color="secondary" 
        onClick={handleRefundRequest}
        sx={{ mb: 3 }}
      >
        Request Kit Refund
      </Button>
      
      <Card>
        <CardContent>
          <Typography variant="h6" gutterBottom>Refund Policy</Typography>
          <Typography variant="body2" paragraph>
            • Early returns: Full refund minus damage fees<br/>
            • On-time returns: Full refund minus damage fees<br/>
            • Late returns: Penalty applied based on delay
          </Typography>
        </CardContent>
      </Card>
    </Box>
  );

  const tabContentVariants = {
    hidden: { opacity: 0, x: 40 },
    visible: { opacity: 1, x: 0, transition: { duration: 0.5 } },
    exit: { opacity: 0, x: -40, transition: { duration: 0.3 } },
  };

  return (
    <Box sx={{ display: 'flex', minHeight: '100vh', background: 'linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%)' }}>
      {/* Side Navigation */}
      <Drawer
        variant="permanent"
        sx={{
          width: drawerWidth,
          flexShrink: 0,
          [`& .MuiDrawer-paper`]: { width: drawerWidth, boxSizing: 'border-box', background: '#fff', borderRight: '1px solid #e0e0e0' },
        }}
      >
        <Toolbar sx={{ minHeight: 80 }} />
        <List>
          {navItems.map((item) => (
            <ListItem key={item.key} disablePadding>
              <ListItemButton
                selected={activeTab === item.key}
                onClick={() => setActiveTab(item.key)}
                sx={{ borderRadius: 2, mx: 1, my: 0.5 }}
              >
                <ListItemIcon>{item.icon}</ListItemIcon>
                <ListItemText primary={item.label} />
              </ListItemButton>
            </ListItem>
          ))}
        </List>
      </Drawer>
      {/* Main Content Area */}
      <Box sx={{ flexGrow: 1, bgcolor: '#f5f7fa', minHeight: '100vh', width: '100%', display: 'flex', flexDirection: 'column' }}>
        {/* Header */}
        <AppBar position="fixed" color="inherit" elevation={2} sx={{ zIndex: (theme) => theme.zIndex.drawer + 1, background: '#fff' }}>
          <Toolbar sx={{ display: 'flex', justifyContent: 'space-between', minHeight: 80 }}>
            <Box sx={{ display: 'flex', alignItems: 'center', gap: 2 }}>
              <img src={require('./logo.svg').default} alt="Logo" style={{ width: 48, marginRight: 12 }} />
              <Typography variant="h4" fontWeight={700} color="primary" sx={{ letterSpacing: 1 }}>Leader Portal</Typography>
            </Box>
            <Button variant="outlined" color="primary" onClick={onLogout} sx={{ fontWeight: 700 }}>Logout</Button>
          </Toolbar>
        </AppBar>
        {/* Spacer for AppBar */}
        <Toolbar sx={{ minHeight: 80 }} />
        {/* Dashboard Container */}
        <Box sx={{ flex: 1, width: '100%', display: 'flex', flexDirection: 'column', alignItems: 'center', py: 4 }}>
          <Box sx={{ width: '100%', maxWidth: 1200, px: 2 }}>
            {message && <Alert sx={{ mb: 2 }} severity={message.includes('success') ? 'success' : 'error'}>{message}</Alert>}
            <AnimatePresence mode="wait">
              {activeTab === 'kits' && (
                <motion.div
                  key="kits"
                  variants={tabContentVariants}
                  initial="hidden"
                  animate="visible"
                  exit="exit"
                >
                  {renderKitRental()}
                </motion.div>
              )}
              {activeTab === 'wallet' && (
                <motion.div
                  key="wallet"
                  variants={tabContentVariants}
                  initial="hidden"
                  animate="visible"
                  exit="exit"
                >
                  {renderWallet()}
                </motion.div>
              )}
              {activeTab === 'refunds' && (
                <motion.div
                  key="refunds"
                  variants={tabContentVariants}
                  initial="hidden"
                  animate="visible"
                  exit="exit"
                >
                  {renderRefundRequests()}
                </motion.div>
              )}
            </AnimatePresence>
          </Box>
        </Box>
      </Box>
      {/* Kit Detail Dialog */}
      <Dialog open={kitDetailDialog} onClose={() => setKitDetailDialog(false)} maxWidth="md" fullWidth>
        <DialogTitle>Kit Details</DialogTitle>
        <DialogContent>
          {selectedKit && (
            <Box>
              <Typography variant="h6" gutterBottom>{selectedKit.name}</Typography>
              <Typography variant="body1" color="text.secondary" paragraph>{selectedKit.description}</Typography>
              
              <Typography variant="subtitle1" gutterBottom>Kit Information:</Typography>
              <Box sx={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 2, mb: 3 }}>
                <Typography><strong>Category:</strong> {selectedKit.category}</Typography>
                <Typography><strong>Location:</strong> {selectedKit.location}</Typography>
                <Typography><strong>Status:</strong> {selectedKit.status}</Typography>
                <Typography><strong>Price:</strong> {selectedKit.price ? selectedKit.price.toLocaleString() + ' VND' : 'N/A'}</Typography>
                <Typography><strong>Last Maintenance:</strong> {selectedKit.lastMaintenance}</Typography>
                <Typography><strong>Next Maintenance:</strong> {selectedKit.nextMaintenance}</Typography>
              </Box>

              <Typography variant="subtitle1" gutterBottom>Components:</Typography>
              <TableContainer component={Paper} sx={{ mb: 2 }}>
                <Table size="small">
                  <TableHead>
                    <TableRow>
                      <TableCell>Component</TableCell>
                      <TableCell>Quantity</TableCell>
                      <TableCell>Condition</TableCell>
                    </TableRow>
                  </TableHead>
                  <TableBody>
                    {selectedKit.components?.map((component, idx) => (
                      <TableRow key={idx}>
                        <TableCell>{component.name}</TableCell>
                        <TableCell>{component.quantity}</TableCell>
                        <TableCell>
                          <Chip 
                            label={component.condition} 
                            color={component.condition === 'New' ? 'success' : 'default'} 
                            size="small" 
                          />
                        </TableCell>
                      </TableRow>
                    ))}
                  </TableBody>
                </Table>
              </TableContainer>
            </Box>
          )}
        </DialogContent>
        <DialogActions>
          <Button onClick={() => setKitDetailDialog(false)}>Close</Button>
        </DialogActions>
      </Dialog>

      {/* Refund Request Dialog */}
      <Dialog open={refundDialog} onClose={() => setRefundDialog(false)} maxWidth="sm" fullWidth>
        <DialogTitle>Request Kit Refund</DialogTitle>
        <DialogContent>
          <Typography variant="body2" color="text.secondary" sx={{ mb: 2 }}>
            Please provide details for your refund request. Late returns may incur penalties.
          </Typography>
          
          <TextField
            fullWidth
            label="Refund Reason"
            multiline
            rows={3}
            value={refundReason}
            onChange={(e) => setRefundReason(e.target.value)}
            placeholder="Explain why you want to return the kit..."
            sx={{ mb: 2 }}
          />
          
          <TextField
            fullWidth
            label="Requested Refund Date"
            type="date"
            value={refundDate}
            onChange={(e) => setRefundDate(e.target.value)}
            InputLabelProps={{ shrink: true }}
            sx={{ mb: 2 }}
          />
          
          <Alert severity="info" sx={{ mb: 2 }}>
            <Typography variant="body2">
              <strong>Refund Policy:</strong><br/>
              • Early returns: Full refund minus damage fees<br/>
              • On-time returns: Full refund minus damage fees<br/>
              • Late returns: Penalty applied based on delay
            </Typography>
          </Alert>
        </DialogContent>
        <DialogActions>
          <Button onClick={() => setRefundDialog(false)}>Cancel</Button>
          <Button onClick={handleRefundSubmit} variant="contained" color="primary">
            Submit Request
          </Button>
        </DialogActions>
      </Dialog>
    </Box>
  );
}
function LecturerPortal({ user, onLogout }) {
  const navigate = useNavigate();
  const [lecturerGroups, setLecturerGroups] = useState([]);
  const [message, setMessage] = useState('');
  const [importType, setImportType] = useState('');
  const [kits, setKits] = useState(mockKits);
  const [kitsLoading, setKitsLoading] = useState(false);
  const [wallet, setWallet] = useState(mockWallet);
  const [selectedKit, setSelectedKit] = useState(null);
  const [kitDetailDialog, setKitDetailDialog] = useState(false);
  const [refundDialog, setRefundDialog] = useState(false);
  const [refundReason, setRefundReason] = useState('');
  const [refundDate, setRefundDate] = useState('');
  const [activeTab, setActiveTab] = useState('groups');
  
  useEffect(() => {
    // Use mockGroups for lecturer
    setLecturerGroups(mockGroups.filter(g => g.lecturer === user?.email));
  }, [user]);
  
  if (!user) return null;

  const drawerWidth = 220;
  const navItems = [
    { key: 'groups', label: 'Groups', icon: <GroupIcon /> },
    { key: 'kits', label: 'Kit Rental', icon: <InventoryIcon /> },
    { key: 'wallet', label: 'Wallet', icon: <MonetizationOnIcon /> },
    { key: 'refunds', label: 'Refund Requests', icon: <ReplayIcon /> },
  ];

  const handleTopUp = async () => {
    setMessage('');
    try {
      // Simulate top-up
      setWallet(prev => ({
        ...prev,
        balance: prev.balance + 100000,
        transactions: [...prev.transactions, {
          type: 'Top-up',
          amount: 100000,
          date: new Date().toISOString().split('T')[0]
        }]
      }));
      setMessage('Top-up successful!');
    } catch (error) {
      setMessage(error.message || 'Top-up failed');
    }
  };

  const handleChooseKit = async (kitName) => {
    // Find the selected kit
    const selectedKit = kits.find(k => k.name === kitName);
    if (!selectedKit) {
      setMessage('Kit not found');
      return;
    }
    
    // Navigate to rental request page
    navigate('/rental-request', { 
      state: { 
        kit: selectedKit, 
        user: user 
      } 
    });
  };

  const handleRefundRequest = () => {
    setRefundDialog(true);
  };

  const handleRefundSubmit = async () => {
    if (!refundReason.trim() || !refundDate) {
      setMessage('Please fill in all fields');
      return;
    }

    try {
      // Simulate refund request submission
      setMessage('Refund request submitted successfully!');
      setRefundDialog(false);
      setRefundReason('');
      setRefundDate('');
    } catch (error) {
      setMessage(error.message || 'Failed to submit refund request');
    }
  };

  const handleFileUpload = async (event, type) => {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = async (e) => {
      try {
        const workbook = XLSX.read(e.target.result, { type: 'binary' });
        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];
        const data = XLSX.utils.sheet_to_json(worksheet);

        if (type === 'students') {
          // Simulate student import
          setMessage('Students imported successfully!');
        }
      } catch (error) {
        setMessage('Error processing file');
      }
    };
    reader.readAsBinaryString(file);
  };



  const renderGroups = () => (
    <Box>
      <Typography variant="h5" gutterBottom>Assigned Groups</Typography>
      {lecturerGroups.length === 0 ? (
        <Typography>You have no groups assigned as a lecturer.</Typography>
      ) : (
        <TableContainer component={Paper}>
          <Table>
            <TableHead>
              <TableRow>
                <TableCell>Group Name</TableCell>
                <TableCell>Leader</TableCell>
                <TableCell>Members</TableCell>
                <TableCell>Member Count</TableCell>
              </TableRow>
            </TableHead>
            <TableBody>
              {lecturerGroups.map((g, i) => (
                <TableRow key={i}>
                  <TableCell>{g.name}</TableCell>
                  <TableCell>{g.leader}</TableCell>
                  <TableCell>{g.members.join(', ')}</TableCell>
                  <TableCell>{g.members.length}/4</TableCell>
                </TableRow>
              ))}
            </TableBody>
          </Table>
        </TableContainer>
      )}
    </Box>
  );

  const renderKitRental = () => (
    <Box>
      <Typography variant="h5" gutterBottom>Kit Rental</Typography>
      <Typography variant="h6" sx={{ mt: 2 }}>Available Kits for Rental</Typography>
      {kitsLoading ? (
        <Typography>Loading kits...</Typography>
      ) : kits.length > 0 ? (
        <TableContainer component={Paper}>
          <Table>
            <TableHead>
              <TableRow>
                <TableCell>Name</TableCell>
                <TableCell>Category</TableCell>
                <TableCell>Quantity</TableCell>
                <TableCell>Price</TableCell>
                <TableCell>Status</TableCell>
                <TableCell>Actions</TableCell>
              </TableRow>
            </TableHead>
            <TableBody>
              {kits.map((k, i) => (
                <TableRow key={i}>
                  <TableCell>
                    <Button
                      variant="text"
                      size="small"
                      onClick={() => {
                        setSelectedKit(k);
                        setKitDetailDialog(true);
                      }}
                    >
                      {k.name}
                    </Button>
                  </TableCell>
                  <TableCell>
                    <Chip 
                      label={k.category || 'N/A'} 
                      color={k.category === 'Advanced' ? 'warning' : k.category === 'Professional' ? 'error' : 'default'} 
                      size="small" 
                    />
                  </TableCell>
                  <TableCell>{k.quantity}</TableCell>
                  <TableCell>{k.price ? k.price.toLocaleString() + ' VND' : 'N/A'}</TableCell>
                  <TableCell>
                    <Chip 
                      label={k.status} 
                      color={k.status === 'AVAILABLE' ? 'success' : k.status === 'IN-USE' ? 'warning' : 'error'} 
                      size="small" 
                    />
                  </TableCell>
                  <TableCell>
                    <Button
                      variant="contained"
                      size="small"
                      disabled={k.quantity === 0 || k.status !== 'AVAILABLE'}
                      onClick={() => handleChooseKit(k.name)}
                    >
                      Rent Kit
                    </Button>
                  </TableCell>
                </TableRow>
              ))}
            </TableBody>
          </Table>
        </TableContainer>
      ) : (
        <Typography>No kits available for rental.</Typography>
      )}
    </Box>
  );

  const renderWallet = () => (
    <Box>
      <Typography variant="h5" gutterBottom>Wallet Management</Typography>
      <Card sx={{ mb: 3 }}>
        <CardContent>
          <Typography variant="h4" color="primary" gutterBottom>
            Balance: {wallet.balance.toLocaleString()} VND
          </Typography>
          <Button 
            variant="contained" 
            color="primary" 
            onClick={handleTopUp}
            sx={{ mb: 2 }}
          >
            Top Up 100,000 VND
          </Button>
        </CardContent>
      </Card>

      <Typography variant="h6" gutterBottom>Transaction History</Typography>
      <TableContainer component={Paper}>
        <Table>
          <TableHead>
            <TableRow>
              <TableCell>Type</TableCell>
              <TableCell>Amount</TableCell>
              <TableCell>Date</TableCell>
            </TableRow>
          </TableHead>
          <TableBody>
            {wallet.transactions.map((tx, idx) => (
              <TableRow key={idx}>
                <TableCell>{tx.type}</TableCell>
                <TableCell>{tx.amount.toLocaleString()} VND</TableCell>
                <TableCell>{tx.date}</TableCell>
              </TableRow>
            ))}
          </TableBody>
        </Table>
      </TableContainer>
    </Box>
  );

  const renderRefundRequests = () => (
    <Box>
      <Typography variant="h5" gutterBottom>Refund Requests</Typography>
      <Button 
        variant="contained" 
        color="secondary" 
        onClick={handleRefundRequest}
        sx={{ mb: 3 }}
      >
        Request Kit Refund
      </Button>
      
      <Card>
        <CardContent>
          <Typography variant="h6" gutterBottom>Refund Policy</Typography>
          <Typography variant="body2" paragraph>
            • Early returns: Full refund minus damage fees<br/>
            • On-time returns: Full refund minus damage fees<br/>
            • Late returns: Penalty applied based on delay
          </Typography>
        </CardContent>
      </Card>
    </Box>
  );

  const tabContentVariants = {
    hidden: { opacity: 0, x: 40 },
    visible: { opacity: 1, x: 0, transition: { duration: 0.5 } },
    exit: { opacity: 0, x: -40, transition: { duration: 0.3 } },
  };

  return (
    <Box sx={{ display: 'flex', minHeight: '100vh', background: 'linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%)' }}>
      {/* Side Navigation */}
      <Drawer
        variant="permanent"
        sx={{
          width: drawerWidth,
          flexShrink: 0,
          [`& .MuiDrawer-paper`]: { width: drawerWidth, boxSizing: 'border-box', background: '#fff', borderRight: '1px solid #e0e0e0' },
        }}
      >
        <Toolbar sx={{ minHeight: 80 }} />
        <List>
          {navItems.map((item) => (
            <ListItem key={item.key} disablePadding>
              <ListItemButton
                selected={activeTab === item.key}
                onClick={() => setActiveTab(item.key)}
                sx={{ borderRadius: 2, mx: 1, my: 0.5 }}
              >
                <ListItemIcon>{item.icon}</ListItemIcon>
                <ListItemText primary={item.label} />
              </ListItemButton>
            </ListItem>
          ))}
        </List>
      </Drawer>
      {/* Main Content Area */}
      <Box sx={{ flexGrow: 1, bgcolor: '#f5f7fa', minHeight: '100vh', width: '100%', display: 'flex', flexDirection: 'column' }}>
        {/* Header */}
        <AppBar position="fixed" color="inherit" elevation={2} sx={{ zIndex: (theme) => theme.zIndex.drawer + 1, background: '#fff' }}>
          <Toolbar sx={{ display: 'flex', justifyContent: 'space-between', minHeight: 80 }}>
            <Box sx={{ display: 'flex', alignItems: 'center', gap: 2 }}>
              <img src={require('./logo.svg').default} alt="Logo" style={{ width: 48, marginRight: 12 }} />
              <Typography variant="h4" fontWeight={700} color="primary" sx={{ letterSpacing: 1 }}>Lecturer Portal</Typography>
            </Box>
            <Button variant="outlined" color="primary" onClick={onLogout} sx={{ fontWeight: 700 }}>Logout</Button>
          </Toolbar>
        </AppBar>
        {/* Spacer for AppBar */}
        <Toolbar sx={{ minHeight: 80 }} />
        {/* Dashboard Container */}
        <Box sx={{ flex: 1, width: '100%', display: 'flex', flexDirection: 'column', alignItems: 'center', py: 4 }}>
          <Box sx={{ width: '100%', maxWidth: 1200, px: 2 }}>
            {message && <Alert sx={{ mb: 2 }} severity={message.includes('success') ? 'success' : 'error'}>{message}</Alert>}
            <AnimatePresence mode="wait">
              {activeTab === 'groups' && (
                <motion.div
                  key="groups"
                  variants={tabContentVariants}
                  initial="hidden"
                  animate="visible"
                  exit="exit"
                >
                  {renderGroups()}
                </motion.div>
              )}
              {activeTab === 'kits' && (
                <motion.div
                  key="kits"
                  variants={tabContentVariants}
                  initial="hidden"
                  animate="visible"
                  exit="exit"
                >
                  {renderKitRental()}
                </motion.div>
              )}
              {activeTab === 'wallet' && (
                <motion.div
                  key="wallet"
                  variants={tabContentVariants}
                  initial="hidden"
                  animate="visible"
                  exit="exit"
                >
                  {renderWallet()}
                </motion.div>
              )}
              {activeTab === 'refunds' && (
                <motion.div
                  key="refunds"
                  variants={tabContentVariants}
                  initial="hidden"
                  animate="visible"
                  exit="exit"
                >
                  {renderRefundRequests()}
                </motion.div>
              )}
            </AnimatePresence>
          </Box>
        </Box>
      </Box>
      {/* Kit Detail Dialog */}
      <Dialog open={kitDetailDialog} onClose={() => setKitDetailDialog(false)} maxWidth="md" fullWidth>
        <DialogTitle>Kit Details</DialogTitle>
        <DialogContent>
          {selectedKit && (
            <Box>
              <Typography variant="h6" gutterBottom>{selectedKit.name}</Typography>
              <Typography variant="body1" color="text.secondary" paragraph>{selectedKit.description}</Typography>
              
              <Typography variant="subtitle1" gutterBottom>Kit Information:</Typography>
              <Box sx={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 2, mb: 3 }}>
                <Typography><strong>Category:</strong> {selectedKit.category}</Typography>
                <Typography><strong>Location:</strong> {selectedKit.location}</Typography>
                <Typography><strong>Status:</strong> {selectedKit.status}</Typography>
                <Typography><strong>Price:</strong> {selectedKit.price ? selectedKit.price.toLocaleString() + ' VND' : 'N/A'}</Typography>
                <Typography><strong>Last Maintenance:</strong> {selectedKit.lastMaintenance}</Typography>
                <Typography><strong>Next Maintenance:</strong> {selectedKit.nextMaintenance}</Typography>
              </Box>

              <Typography variant="subtitle1" gutterBottom>Components:</Typography>
              <TableContainer component={Paper} sx={{ mb: 2 }}>
                <Table size="small">
                  <TableHead>
                    <TableRow>
                      <TableCell>Component</TableCell>
                      <TableCell>Quantity</TableCell>
                      <TableCell>Condition</TableCell>
                    </TableRow>
                  </TableHead>
                  <TableBody>
                    {selectedKit.components?.map((component, idx) => (
                      <TableRow key={idx}>
                        <TableCell>{component.name}</TableCell>
                        <TableCell>{component.quantity}</TableCell>
                        <TableCell>
                          <Chip 
                            label={component.condition} 
                            color={component.condition === 'New' ? 'success' : 'default'} 
                            size="small" 
                          />
                        </TableCell>
                      </TableRow>
                    ))}
                  </TableBody>
                </Table>
              </TableContainer>
            </Box>
          )}
        </DialogContent>
        <DialogActions>
          <Button onClick={() => setKitDetailDialog(false)}>Close</Button>
        </DialogActions>
      </Dialog>

      {/* Refund Request Dialog */}
      <Dialog open={refundDialog} onClose={() => setRefundDialog(false)} maxWidth="sm" fullWidth>
        <DialogTitle>Request Kit Refund</DialogTitle>
        <DialogContent>
          <Typography variant="body2" color="text.secondary" sx={{ mb: 2 }}>
            Please provide details for your refund request. Late returns may incur penalties.
          </Typography>
          
          <TextField
            fullWidth
            label="Refund Reason"
            multiline
            rows={3}
            value={refundReason}
            onChange={(e) => setRefundReason(e.target.value)}
            placeholder="Explain why you want to return the kit..."
            sx={{ mb: 2 }}
          />
          
          <TextField
            fullWidth
            label="Requested Refund Date"
            type="date"
            value={refundDate}
            onChange={(e) => setRefundDate(e.target.value)}
            InputLabelProps={{ shrink: true }}
            sx={{ mb: 2 }}
          />
          
          <Alert severity="info" sx={{ mb: 2 }}>
            <Typography variant="body2">
              <strong>Refund Policy:</strong><br/>
              • Early returns: Full refund minus damage fees<br/>
              • On-time returns: Full refund minus damage fees<br/>
              • Late returns: Penalty applied based on delay
            </Typography>
          </Alert>
        </DialogContent>
        <DialogActions>
          <Button onClick={() => setRefundDialog(false)}>Cancel</Button>
          <Button onClick={handleRefundSubmit} variant="contained" color="primary">
            Submit Request
          </Button>
        </DialogActions>
      </Dialog>
    </Box>
  );
}





function MemberPortal({ user, onLogout }) {
  const [group, setGroup] = useState(null);
  const [loading, setLoading] = useState(true);
  const [kits, setKits] = useState(mockKits);
  const [kitsLoading, setKitsLoading] = useState(false);
  const [wallet, setWallet] = useState(mockWallet);
  const [activeTab, setActiveTab] = useState('group');
  const [selectedKit, setSelectedKit] = useState(null);
  const [kitDetailDialog, setKitDetailDialog] = useState(false);

  useEffect(() => {
    setLoading(true);
    // Use mockGroups for member
    const found = mockGroups.find(g => g.members.includes(user.email));
    setGroup(found || null);
    setLoading(false);
  }, [user]);

  if (!user) return null;

  const drawerWidth = 220;
  const navItems = [
    { key: 'group', label: 'Group Info', icon: <GroupIcon /> },
    { key: 'kits', label: 'Available Kits', icon: <InventoryIcon /> },
    { key: 'wallet', label: 'Wallet', icon: <MonetizationOnIcon /> },
  ];

  const renderGroupInfo = () => (
    <Box>
      <Typography variant="h5" gutterBottom>Group Information</Typography>
      {loading ? (
        <Typography>Loading group info...</Typography>
      ) : group ? (
        <Card sx={{ bgcolor: 'primary.light', color: 'white', mb: 3 }}>
          <CardContent>
            <Typography variant="h6" gutterBottom>Group Details</Typography>
            <Grid container spacing={2}>
              <Grid item xs={12} md={6}>
                <Typography variant="body1">
                  <strong>Group Name:</strong> {group.name}
                </Typography>
                <Typography variant="body1">
                  <strong>Total Members:</strong> {group.members.length + 1} (including you)
                </Typography>
              </Grid>
              <Grid item xs={12} md={6}>
                <Typography variant="body1">
                  <strong>Leader:</strong> {group.leader}
                </Typography>
                {group.lecturer && (
                  <Typography variant="body1">
                    <strong>Lecturer:</strong> {group.lecturer}
                  </Typography>
                )}
              </Grid>
            </Grid>
            <Typography variant="body1" sx={{ mt: 2 }}>
              <strong>Members:</strong> {group.members.join(', ')}
            </Typography>
          </CardContent>
        </Card>
      ) : (
        <Alert severity="warning">
          <Typography variant="body1">No group found for this member.</Typography>
        </Alert>
      )}
    </Box>
  );

  const renderKits = () => (
    <Box>
      <Typography variant="h5" gutterBottom>Available Kits</Typography>
      {kitsLoading ? (
        <Typography>Loading kits...</Typography>
      ) : kits.length > 0 ? (
        <TableContainer component={Paper}>
          <Table>
            <TableHead>
              <TableRow>
                <TableCell>Name</TableCell>
                <TableCell>Category</TableCell>
                <TableCell>Quantity</TableCell>
                <TableCell>Price</TableCell>
                <TableCell>Status</TableCell>
                <TableCell>Actions</TableCell>
              </TableRow>
            </TableHead>
            <TableBody>
              {kits.map((k, i) => (
                <TableRow key={i}>
                  <TableCell>
                    <Button
                      variant="text"
                      size="small"
                      onClick={() => {
                        setSelectedKit(k);
                        setKitDetailDialog(true);
                      }}
                    >
                      {k.name}
                    </Button>
                  </TableCell>
                  <TableCell>
                    <Chip 
                      label={k.category || 'N/A'} 
                      color={k.category === 'Advanced' ? 'warning' : k.category === 'Professional' ? 'error' : 'default'} 
                      size="small" 
                    />
                  </TableCell>
                  <TableCell>{k.quantity}</TableCell>
                  <TableCell>{k.price ? k.price.toLocaleString() + ' VND' : 'N/A'}</TableCell>
                  <TableCell>
                    <Chip 
                      label={k.status} 
                      color={k.status === 'AVAILABLE' ? 'success' : k.status === 'IN-USE' ? 'warning' : 'error'} 
                      size="small" 
                    />
                  </TableCell>
                  <TableCell>
                    <Button
                      variant="outlined"
                      size="small"
                      disabled={k.quantity === 0 || k.status !== 'AVAILABLE'}
                    >
                      View Details
                    </Button>
                  </TableCell>
                </TableRow>
              ))}
            </TableBody>
          </Table>
        </TableContainer>
      ) : (
        <Typography>No kits available.</Typography>
      )}
    </Box>
  );

  const renderWallet = () => (
    <Box>
      <Typography variant="h5" gutterBottom>Wallet Management</Typography>
      <Card sx={{ mb: 3 }}>
        <CardContent>
          <Typography variant="h4" color="primary" gutterBottom>
            Balance: {wallet.balance.toLocaleString()} VND
          </Typography>
        </CardContent>
      </Card>

      <Typography variant="h6" gutterBottom>Transaction History</Typography>
      <TableContainer component={Paper}>
        <Table>
          <TableHead>
            <TableRow>
              <TableCell>Type</TableCell>
              <TableCell>Amount</TableCell>
              <TableCell>Date</TableCell>
            </TableRow>
          </TableHead>
          <TableBody>
            {wallet.transactions.map((tx, idx) => (
              <TableRow key={idx}>
                <TableCell>{tx.type}</TableCell>
                <TableCell>{tx.amount.toLocaleString()} VND</TableCell>
                <TableCell>{tx.date}</TableCell>
              </TableRow>
            ))}
          </TableBody>
        </Table>
      </TableContainer>
    </Box>
  );

  const tabContentVariants = {
    hidden: { opacity: 0, x: 40 },
    visible: { opacity: 1, x: 0, transition: { duration: 0.5 } },
    exit: { opacity: 0, x: -40, transition: { duration: 0.3 } },
  };

  return (
    <Box sx={{ display: 'flex', minHeight: '100vh', background: 'linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%)' }}>
      {/* Side Navigation */}
      <Drawer
        variant="permanent"
        sx={{
          width: drawerWidth,
          flexShrink: 0,
          [`& .MuiDrawer-paper`]: { width: drawerWidth, boxSizing: 'border-box', background: '#fff', borderRight: '1px solid #e0e0e0' },
        }}
      >
        <Toolbar sx={{ minHeight: 80 }} />
        <List>
          {navItems.map((item) => (
            <ListItem key={item.key} disablePadding>
              <ListItemButton
                selected={activeTab === item.key}
                onClick={() => setActiveTab(item.key)}
                sx={{ borderRadius: 2, mx: 1, my: 0.5 }}
              >
                <ListItemIcon>{item.icon}</ListItemIcon>
                <ListItemText primary={item.label} />
              </ListItemButton>
            </ListItem>
          ))}
        </List>
      </Drawer>
      {/* Main Content Area */}
      <Box sx={{ flexGrow: 1, bgcolor: '#f5f7fa', minHeight: '100vh', width: '100%', display: 'flex', flexDirection: 'column' }}>
        {/* Header */}
        <AppBar position="fixed" color="inherit" elevation={2} sx={{ zIndex: (theme) => theme.zIndex.drawer + 1, background: '#fff' }}>
          <Toolbar sx={{ display: 'flex', justifyContent: 'space-between', minHeight: 80 }}>
            <Box sx={{ display: 'flex', alignItems: 'center', gap: 2 }}>
              <img src={require('./logo.svg').default} alt="Logo" style={{ width: 48, marginRight: 12 }} />
              <Typography variant="h4" fontWeight={700} color="primary" sx={{ letterSpacing: 1 }}>Member Portal</Typography>
            </Box>
            <Button variant="outlined" color="primary" onClick={onLogout} sx={{ fontWeight: 700 }}>Logout</Button>
          </Toolbar>
        </AppBar>
        {/* Spacer for AppBar */}
        <Toolbar sx={{ minHeight: 80 }} />
        {/* Dashboard Container */}
        <Box sx={{ flex: 1, width: '100%', display: 'flex', flexDirection: 'column', alignItems: 'center', py: 4 }}>
          <Box sx={{ width: '100%', maxWidth: 1200, px: 2 }}>
            <AnimatePresence mode="wait">
              {activeTab === 'group' && (
                <motion.div
                  key="group"
                  variants={tabContentVariants}
                  initial="hidden"
                  animate="visible"
                  exit="exit"
                >
                  {renderGroupInfo()}
                </motion.div>
              )}
              {activeTab === 'kits' && (
                <motion.div
                  key="kits"
                  variants={tabContentVariants}
                  initial="hidden"
                  animate="visible"
                  exit="exit"
                >
                  {renderKits()}
                </motion.div>
              )}
              {activeTab === 'wallet' && (
                <motion.div
                  key="wallet"
                  variants={tabContentVariants}
                  initial="hidden"
                  animate="visible"
                  exit="exit"
                >
                  {renderWallet()}
                </motion.div>
              )}
            </AnimatePresence>
          </Box>
        </Box>
      </Box>
      {/* Kit Detail Dialog */}
      <Dialog open={kitDetailDialog} onClose={() => setKitDetailDialog(false)} maxWidth="md" fullWidth>
        <DialogTitle>Kit Details</DialogTitle>
        <DialogContent>
          {selectedKit && (
            <Box>
              <Typography variant="h6" gutterBottom>{selectedKit.name}</Typography>
              <Typography variant="body1" color="text.secondary" paragraph>{selectedKit.description}</Typography>
              
              <Typography variant="subtitle1" gutterBottom>Kit Information:</Typography>
              <Box sx={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 2, mb: 3 }}>
                <Typography><strong>Category:</strong> {selectedKit.category}</Typography>
                <Typography><strong>Location:</strong> {selectedKit.location}</Typography>
                <Typography><strong>Status:</strong> {selectedKit.status}</Typography>
                <Typography><strong>Price:</strong> {selectedKit.price ? selectedKit.price.toLocaleString() + ' VND' : 'N/A'}</Typography>
                <Typography><strong>Last Maintenance:</strong> {selectedKit.lastMaintenance}</Typography>
                <Typography><strong>Next Maintenance:</strong> {selectedKit.nextMaintenance}</Typography>
              </Box>

              <Typography variant="subtitle1" gutterBottom>Components:</Typography>
              <TableContainer component={Paper} sx={{ mb: 2 }}>
                <Table size="small">
                  <TableHead>
                    <TableRow>
                      <TableCell>Component</TableCell>
                      <TableCell>Quantity</TableCell>
                      <TableCell>Condition</TableCell>
                    </TableRow>
                  </TableHead>
                  <TableBody>
                    {selectedKit.components?.map((component, idx) => (
                      <TableRow key={idx}>
                        <TableCell>{component.name}</TableCell>
                        <TableCell>{component.quantity}</TableCell>
                        <TableCell>
                          <Chip 
                            label={component.condition} 
                            color={component.condition === 'New' ? 'success' : 'default'} 
                            size="small" 
                          />
                        </TableCell>
                      </TableRow>
                    ))}
                  </TableBody>
                </Table>
              </TableContainer>
            </Box>
          )}
        </DialogContent>
        <DialogActions>
          <Button onClick={() => setKitDetailDialog(false)}>Close</Button>
        </DialogActions>
      </Dialog>
    </Box>
  );
}

function App() {
  const [user, setUser] = useState(null);
  const [role, setRole] = useState('student');
  const navigate = useNavigate();
  const [shouldLogout, setShouldLogout] = useState(false);

  const handleLogin = (userData) => {
    setUser(userData);
    setRole(userData.role || 'student');
  };
  const handleLogout = () => {
    setUser(null);
    setRole('student');
    setShouldLogout(true);
  };

  useEffect(() => {
    if (shouldLogout) {
      navigate('/');
      setShouldLogout(false);
    }
  }, [shouldLogout, navigate]);

  // English role options for banner
  const roleOptions = [
    { value: 'lecturer', label: 'Lecturer' },
    { value: 'admin', label: 'Admin (Librarian)' },
    { value: 'academic', label: 'Academic Affairs' },
  ];

  // Only show the current role if logged in
  const visibleRoleOptions = user
    ? roleOptions.filter(opt => opt.value === role)
    : roleOptions;

  // Render the selected portal
  let portal = null;
  if (role === 'leader') portal = <LeaderPortal user={user} onLogout={handleLogout} />;
  if (role === 'lecturer') portal = <LecturerPortal user={user} onLogout={handleLogout} />;
  if (role === 'admin') portal = <AdminPortal onLogout={handleLogout} />;
  if (role === 'academic') portal = <AcademicAffairsPortal user={user} onLogout={handleLogout} />;
  if (role === 'member') portal = <MemberPortal user={user} onLogout={handleLogout} />;

  return (
    <>
      {/* Remove the AppBar and Toolbar with role selection */}
      <div className="appbar-spacer" />
      <Box sx={{ p: { xs: 1, sm: 2, md: 4 }, transition: 'padding 0.3s' }}>
        <Routes>
          <Route path="/" element={
            user ? (
              <Box>
                {portal}
              </Box>
            ) : <Home onLogin={handleLogin} user={user} />
          } />
          <Route path="/lecturer" element={<LecturerPortal user={user} onLogout={handleLogout} />} />
                  <Route path="/rental-request" element={<RentalRequestPage />} />
        <Route path="/admin/rental-approval" element={<AdminRentalApprovalPage />} />
        <Route path="/admin/refund-approval" element={<AdminRefundApprovalPage />} />
        </Routes>
      </Box>
    </>
  );
}

function AppWithRouter() {
  return (
    <Router>
      <App />
    </Router>
  );
}

export default AppWithRouter;
